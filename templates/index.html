{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>Telegram Messages</h1>

  <!-- Statistics Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Message Statistics</h5>
      <div class="row">
        <div class="col-md-4">
          <div class="mb-3">
            <h6>Message Counts:</h6>
            <ul class="list-unstyled">
              <li>Total Messages: <strong>{{ all_count }}</strong></li>
              <li>TON Dev Messages: <strong>{{ ton_count }}</strong></li>
              <li>Regular Messages: <strong>{{ all_count - ton_count }}</strong></li>
            </ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <h6>Message Types:</h6>
            <ul class="list-unstyled">
              <li>Inbox Messages: <strong>{{ all_count - outbox_count }}</strong></li>
              <li>Outbox Messages: <strong>{{ outbox_count }}</strong></li>
            </ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <h6>Dialog Types:</h6>
            <ul class="list-unstyled">
              <li>Total Dialogs: <strong>{{ dialog_counts['total'] }}</strong></li>
              <li>Private Chats: <strong>{{ dialog_counts['private']['count'] }}</strong> ({{ dialog_counts['private']['messages'] }} messages)</li>
              <li>Groups: <strong>{{ dialog_counts['group']['count'] }}</strong> ({{ dialog_counts['group']['messages'] }} messages)</li>
              <li>Supergroups: <strong>{{ dialog_counts['supergroup']['count'] }}</strong> ({{ dialog_counts['supergroup']['messages'] }} messages)</li>
              <li>Channels: <strong>{{ dialog_counts['channel']['count'] }}</strong> ({{ dialog_counts['channel']['messages'] }} messages)</li>
              {% if dialog_counts['unknown']['count'] > 0 %}
              <li>Unknown Type: <strong>{{ dialog_counts['unknown']['count'] }}</strong> ({{ dialog_counts['unknown']['messages'] }} messages)</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Message Filters</h5>
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="tonOnlyToggle" {% if show_ton_only %}checked{% endif %}>
            <label class="form-check-label" for="tonOnlyToggle">Show TON Dev messages only</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="outboxOnlyToggle" {% if show_outbox_only %}checked{% endif %}>
            <label class="form-check-label" for="outboxOnlyToggle">Show outbox messages only</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Display -->
  <div class="row">
    {% for message in messages %}
    <div class="col-md-6 mb-3">
      <div class="card {% if message.is_ton_dev %}border-primary{% endif %} {% if message.is_outgoing %}border-success{% endif %}">
        <div class="card-header {% if message.is_ton_dev %}bg-primary text-white{% endif %} {% if message.is_outgoing %}bg-success text-white{% endif %}">
          <strong>{{ message.channel_title }}</strong>
          {% if message.is_ton_dev %}<span class="badge bg-warning text-dark ms-2">TON</span>{% endif %}
          <span class="badge {% if message.is_outgoing %}bg-light text-dark{% else %}bg-secondary text-white{% endif %} ms-2">
            {% if message.is_outgoing %}Outbox{% else %}Inbox{% endif %}
          </span>
          {% if message.dialog_type %}
          <span class="badge bg-info text-white ms-2">{{ message.dialog_type }}</span>
          {% endif %}
        </div>
        <div class="card-body">
          <p class="card-text">{{ message.content }}</p>
        </div>
        <div class="card-footer text-muted">
          {{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // Handle TON filter
  document.getElementById('tonOnlyToggle').addEventListener('change', function() {
    updateFilters();
  });

  // Handle Outbox filter
  document.getElementById('outboxOnlyToggle').addEventListener('change', function() {
    updateFilters();
  });

  function updateFilters() {
    const tonOnly = document.getElementById('tonOnlyToggle').checked;
    const outboxOnly = document.getElementById('outboxOnlyToggle').checked;
    window.location.href = `/?ton_only=${tonOnly}&outbox_only=${outboxOnly}`;
  }
</script>
{% endblock %}