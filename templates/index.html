{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>Telegram Messages</h1>

  <!-- Daily Statistics Card -->
  <div class="card mb-4">
    <div class="card-body">

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Collector Status</h5>
    <div id="collector-status">
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span>Checking collector status...</span>
      </div>
    </div>
  </div>
</div>

<script>
function checkCollectorStatus() {
  fetch('/api/collector-status')
    .then(response => response.json())
    .then(data => {
      const statusDiv = document.getElementById('collector-status');
      if (data.status === 'active') {
        statusDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
            <span>Collector active - ${data.recent_messages} messages in the last hour</span>
          </div>
          <small class="text-muted">Last message: ${data.minutes_since_last} minutes ago</small>`;
      } else if (data.status === 'inactive') {
        statusDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="bg-warning rounded-circle me-2" style="width: 10px; height: 10px;"></div>
            <span>Collector inactive - No messages in the last hour</span>
          </div>
          <small class="text-muted">Last message: ${data.last_message_time || 'Never'}</small>
          <div class="mt-2">
            <button class="btn btn-sm btn-primary" onclick="restartCollector()">Restart Collector</button>
          </div>`;
      } else {
        statusDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="bg-danger rounded-circle me-2" style="width: 10px; height: 10px;"></div>
            <span>Collector error: ${data.error || 'Unknown error'}</span>
          </div>`;
      }
    })
    .catch(error => {
      document.getElementById('collector-status').innerHTML = `
        <div class="d-flex align-items-center">
          <div class="bg-danger rounded-circle me-2" style="width: 10px; height: 10px;"></div>
          <span>Error checking collector status</span>
        </div>`;
    });
}

function restartCollector() {
  // This would need server-side implementation
  alert('This feature requires server-side implementation.');
}

// Check status on page load
checkCollectorStatus();
// Check every 30 seconds
setInterval(checkCollectorStatus, 30000);
</script>

      <h5 class="card-title">Daily Statistics (Last 3 Days)</h5>
      <div id="dailyStats">Loading...</div>
    </div>
  </div>

  <!-- Statistics Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Message Statistics</h5>
      <div class="row">
        <div class="col-md-4">
          <div class="mb-3">
            <h6>Message Counts:</h6>
            <ul class="list-unstyled">
              <li>Total Messages: <strong id="totalMessages">{{ all_count }}</strong></li>
              <li>TON Dev Messages: <strong id="tonMessages">{{ ton_count }}</strong></li>
              <li>Regular Messages: <strong id="regularMessages">{{ all_count - ton_count }}</strong></li>
            </ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <h6>Message Types:</h6>
            <ul class="list-unstyled">
              <li>Inbox Messages: <strong id="inboxMessages">{{ all_count - outbox_count }}</strong></li>
              <li>Outbox Messages: <strong id="outboxMessages">{{ outbox_count }}</strong></li>
            </ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <h6>Dialog Types:</h6>
            <ul class="list-unstyled" id="dialogStats">
              <li>Total Dialogs: <strong>{{ dialog_counts['total'] }}</strong></li>
              <li>Private Chats: <strong>{{ dialog_counts['private']['count'] }}</strong> (<span>{{ dialog_counts['private']['messages'] }}</span> messages)</li>
              <li>Bots: <strong>{{ dialog_counts['bot']['count'] }}</strong> (<span>{{ dialog_counts['bot']['messages'] }}</span> messages)</li>
              <li>Groups: <strong>{{ dialog_counts['group']['count'] }}</strong> (<span>{{ dialog_counts['group']['messages'] }}</span> messages)</li>
              <li>Channels: <strong>{{ dialog_counts['channel']['count'] }}</strong> (<span>{{ dialog_counts['channel']['messages'] }}</span> messages)</li>
              <li>Public Supergroups: <strong>{{ dialog_counts['public_supergroup']['count'] }}</strong> (<span>{{ dialog_counts['public_supergroup']['messages'] }}</span> messages)</li>
              <li>Private Supergroups: <strong>{{ dialog_counts['private_supergroup']['count'] }}</strong> (<span>{{ dialog_counts['private_supergroup']['messages'] }}</span> messages)</li>
              {% if dialog_counts['deleted_account']['count'] > 0 %}
              <li>Deleted Accounts: <strong>{{ dialog_counts['deleted_account']['count'] }}</strong> (<span>{{ dialog_counts['deleted_account']['messages'] }}</span> messages)</li>
              {% endif %}
              {% if dialog_counts['unknown']['count'] > 0 %}
              <li>Unknown Type: <strong>{{ dialog_counts['unknown']['count'] }}</strong> (<span>{{ dialog_counts['unknown']['messages'] }}</span> messages)</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card mb-4">
    <div class="alert alert-danger d-none" id="stats-error"></div>
    <div class="card-body">
      <h5 class="card-title">Message Filters</h5>
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="tonOnlyToggle" {% if show_ton_only %}checked{% endif %}>
            <label class="form-check-label" for="tonOnlyToggle">Show TON Dev messages only</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="outboxOnlyToggle" {% if show_outbox_only %}checked{% endif %}>
            <label class="form-check-label" for="outboxOnlyToggle">Show outbox messages only</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Display -->
  <div class="row">
    {% for message in messages %}
    <div class="col-md-6 mb-3">
      <div class="card {% if message.is_ton_dev %}border-primary{% endif %} {% if message.is_outgoing %}border-success{% endif %}">
        <div class="card-header {% if message.is_ton_dev %}bg-primary text-white{% endif %} {% if message.is_outgoing %}bg-success text-white{% endif %}">
          <strong>{{ message.channel_title }}</strong>
          {% if message.is_ton_dev %}<span class="badge bg-warning text-dark ms-2">TON</span>{% endif %}
          <span class="badge {% if message.is_outgoing %}bg-light text-dark{% else %}bg-secondary text-white{% endif %} ms-2">
            {% if message.is_outgoing %}Outbox{% else %}Inbox{% endif %}
          </span>
          {% if message.dialog_type %}
          <span class="badge bg-info text-white ms-2">{{ message.dialog_type }}</span>
          {% endif %}
        </div>
        <div class="card-body">
          <p class="card-text">{{ message.content }}</p>
        </div>
        <div class="card-footer text-muted">
          {{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
let lastUpdate = "{{ last_update }}";
let errorCount = 0;

function updateStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error("Stats API returned error:", data.error);
                errorCount++;
                if (errorCount > 3) {
                    document.getElementById('stats-error').classList.remove('d-none');
                    document.getElementById('stats-error').innerText = `Error updating stats: ${data.error}`;
                }
                return;
            }
            
            errorCount = 0;
            document.getElementById('stats-error').classList.add('d-none');
            
            // Update daily stats
            const dailyStatsHtml = data.map(day => `
                <div class="border-bottom mb-2 pb-2">
                    <h6>${day.date}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small>Total: ${day.total_messages}</small>
                        </div>
                        <div class="col-md-4">
                            <small>TON: ${day.ton_messages}</small>
                        </div>
                        <div class="col-md-4">
                            <small>Regular: ${day.total_messages - day.ton_messages}</small>
                        </div>
                    </div>
                    <div class="mt-1">
                        <small>
                            ${Object.entries(day.by_type)
                                .map(([type, count]) => `${type}: ${count}`)
                                .join(' | ')}
                        </small>
                    </div>
                </div>
            `).join('');

            document.getElementById('dailyStats').innerHTML = dailyStatsHtml;
        })
        .catch(error => console.error('Error updating stats:', error));
}

// Update stats every 10 seconds
setInterval(updateStats, 10000);

// Initial update
updateStats();

  // Handle TON filter
  document.getElementById('tonOnlyToggle').addEventListener('change', function() {
    updateFilters();
  });

  // Handle Outbox filter
  document.getElementById('outboxOnlyToggle').addEventListener('change', function() {
    updateFilters();
  });

  function updateFilters() {
    const tonOnly = document.getElementById('tonOnlyToggle').checked;
    const outboxOnly = document.getElementById('outboxOnlyToggle').checked;
    window.location.href = `/?ton_only=${tonOnly}&outbox_only=${outboxOnly}`;
  }
</script>
{% endblock %}